{% extends 'home.html' %} {% load static %} {% block title %}Thanh To√°n | The
Goat Shop{% endblock %} {% block content %}
<style>

.modal {
    display: none;
    width: auto;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
}

p {
    margin: 20px;
    font-weight: 300;
    font-size: 25px;
    line-height: 30px;
}

h2 {
    font-size: 25px;
    color: #0471ff;
}

.modal-content {
    background: white;
    padding: 20px;
    text-align: center;
    border-radius: 8px;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
    width: auto;
}

.modal-buttons {
    margin-top: 20px;
}

.btn {
    padding: 10px 15px;
    border: none;
    cursor: pointer;
    margin: 5px;
}

.btn-primary {
    background: #007bff;
    color: white;
}


</style>
<div class="collection_text" style="margin-top: 1%; padding: 20px 0; margin-bottom: 1%;">Thanh to√°n</div>
<div class="container py-4">
  <!-- B·∫£ng s·∫£n ph·∫©m -->
  <div class="card shadow-lg">
    <div class="card-body">
      <table class="table table-hover">
        <thead class="table-dark">
          <tr>
            <th>S·∫£n ph·∫©m</th>
            <th>Gi√° g·ªëc</th>
            <th>Gi·∫£m gi√°</th>
            <th>Gi√° sau gi·∫£m</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>Th√†nh ti·ªÅn</th>
          </tr>
        </thead>
        <tbody>
          {% for item in selected_items %}
          <tr
            data-id="{{ item.san_pham.id }}"
            data-quantity="{{ item.so_luong }}"
          >
            <td>{{ item.san_pham.ten_san_pham }}</td>
            <td><del>{{ item.san_pham.gia | floatformat:0 }} ‚Ç´</del></td>
            <td class="text-danger">{{ item.san_pham.giam_gia }} %</td>
            <td class="text-success">{{ item.san_pham.get_final_price }} ‚Ç´</td>
            <td>{{ item.so_luong }}</td>
            <td class="text-success">
              {% widthratio item.san_pham.get_final_price 1 item.so_luong %} ‚Ç´
          </td>          
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="text-end mt-3">
        <h4>
          <strong>T·ªïng ti·ªÅn: </strong>
          <span class="text-danger">{{ tong_gia }}‚Ç´</span>
        </h4>
      </div>
    </div>
  </div>

  <!-- Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n -->
  <div class="card shadow-lg mt-4">
    <div class="card-body">
      <h3 class="mb-3 text-center">üí≥ Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</h3>
      <form id="paymentForm">
        {% csrf_token %}

        <div class="d-flex justify-content-center gap-4 flex-wrap">
          <label>
            <input type="radio" name="phuong_thuc_tt" value="cod" checked />
            Thanh to√°n khi nh·∫≠n h√†ng (COD)
          </label>
          <label>
            <input type="radio" name="phuong_thuc_tt" value="online" /> Thanh
            to√°n Online
          </label>
        </div>

        <!-- C·ªïng thanh to√°n online (·∫©n m·∫∑c ƒë·ªãnh) -->
        <div
          id="onlinePaymentMethods"
          class="mt-3 p-3 bg-light border rounded text-center"
          style="display: none"
        >
          <h5>Ch·ªçn c·ªïng thanh to√°n</h5>
          <label
            ><input type="radio" name="phuong_thuc_online" value="momo" />
            MoMo</label
          >
          <label
            ><input type="radio" name="phuong_thuc_online" value="zalopay" />
            ZaloPay</label
          >
          <label
            ><input type="radio" name="phuong_thuc_online" value="vnpay" />
            VNPay</label
          >
        </div>

        <div class="d-flex justify-content-between mt-4">
          <button
            type="button"
            class="btn btn-danger btn-lg"
            id="cancelPayment"
          >
            ‚ùå H·ªßy
          </button>
          <button
            type="submit"
            class="btn btn-success btn-lg"
            id="confirmPayment"
          >
            ‚úÖ Thanh to√°n
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Modal x√°c nh·∫≠n sau thanh to√°n -->
<div id="paymentSuccessModal" class="modal">
  <div class="modal-content">
      <h2>üéâ Thanh to√°n th√†nh c√¥ng!</h2>
      <p>B·∫°n mu·ªën l√†m g√¨ ti·∫øp theo?</p>
      <dv class="modal-buttons">
        <a href="{% url 'cart' %}"><button id="goToCartBtn" class="btn">üõí Quay l·∫°i gi·ªè h√†ng</button></a>
        <a href="{% url 'profile' %}"><button id="goToOrdersBtn" class="btn btn-primary">üìú Xem l·ªãch s·ª≠ ƒë∆°n h√†ng</button>
        </dv></a>
  </div>
</div>

<!-- Container th√¥ng b√°o -->
<div
  id="notification-container"
  style="position: fixed; top: 20px; right: 20px"
></div>

<script>
  // ·∫®n/hi·ªán c·ªïng thanh to√°n online v·ªõi hi·ªáu ·ª©ng m∆∞·ª£t m√†
document.querySelectorAll("input[name='phuong_thuc_tt']").forEach((radio) => {
  radio.addEventListener("change", function () {
    const onlinePaymentMethods = document.getElementById("onlinePaymentMethods");
    if (this.value === "online") {
      onlinePaymentMethods.style.display = "block";
      onlinePaymentMethods.classList.add('fade-in');
    } else {
      onlinePaymentMethods.classList.remove('fade-in');
      onlinePaymentMethods.style.display = "none";
    }
  });


    // X·ª≠ l√Ω n√∫t "H·ªßy" - Chuy·ªÉn v·ªÅ trang gi·ªè h√†ng
    document
      .getElementById("cancelPayment")
      .addEventListener("click", function () {
        window.location.href = "/cart/";
      });
  });
</script>

<script>document.addEventListener("DOMContentLoaded", function () {
  const confirmBtn = document.getElementById("confirmPayment");
  const paymentForm = document.getElementById("paymentForm");
  const csrfTokenElement = document.querySelector("input[name='csrfmiddlewaretoken']");
  
  if (!csrfTokenElement) {
      alert("L·ªói h·ªá th·ªëng: Kh√¥ng t√¨m th·∫•y CSRF token!");
      return;
  }
  const csrfToken = csrfTokenElement.value;

  async function getAuthToken() {
      return localStorage.getItem("access_token");
  }

  async function refreshAuthToken() {
      const refreshToken = localStorage.getItem("refresh_token");
      if (!refreshToken) return null;
      
      const response = await fetch("/api/auth/refresh/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ refresh: refreshToken })
      });
      
      if (response.ok) {
          const newTokens = await response.json();
          localStorage.setItem("access_token", newTokens.access);
          return newTokens.access;
      }
      return null;
  }

  async function fetchWithAuth(url, options = {}) {
      let authToken = await getAuthToken();
      
      options.headers = {
          ...(options.headers || {}),
          "Authorization": `Bearer ${authToken}`,
          "X-CSRFToken": csrfToken
      };
      
      let response = await fetch(url, options);
      
      if (response.status === 401) {
          authToken = await refreshAuthToken();
          if (!authToken) {
              alert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!");
              window.location.href = "/login/";
              return;
          }
          options.headers["Authorization"] = `Bearer ${authToken}`;
          response = await fetch(url, options);
      }
      return response;
  }

  async function createOrder(selectedItems, paymentMethod, onlineMethod) {
    try {
        const response = await fetchWithAuth("/api/orders/create/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                items: selectedItems, // ‚úÖ ƒê·ªïi t·ª´ "cart_items" -> "items"
                phuong_thuc_tt: paymentMethod,
                phuong_thuc_online: onlineMethod
            })
        });

        const data = await response.json();
        if (response.ok) {
            return data.order_id; // Tr·∫£ v·ªÅ ID c·ªßa ƒë∆°n h√†ng m·ªõi t·∫°o
        } else {
            alert(data.error || "ƒê·∫∑t h√†ng th·∫•t b·∫°i!");
            return null;
        }
    } catch (error) {
        console.error("L·ªói khi t·∫°o ƒë∆°n h√†ng:", error);
        alert("C√≥ l·ªói x·∫£y ra khi t·∫°o ƒë∆°n h√†ng, vui l√≤ng th·ª≠ l·∫°i!");
        return null;
    }
}

  async function processPayment(orderId, paymentMethod, onlineMethod) {
      try {
          const response = await fetchWithAuth("/api/orders/payment/", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                  don_hang_ids: [orderId],
                  phuong_thuc_tt: paymentMethod,
                  cong_thanh_toan: onlineMethod
              })
          });

          const result = await response.json();
            if (response.ok) {
                document.getElementById("paymentSuccessModal").style.display = "flex";

                // X·ª≠ l√Ω s·ª± ki·ªán khi ng∆∞·ªùi d√πng ch·ªçn h√†nh ƒë·ªông
                document.getElementById("goToCartBtn").addEventListener("click", function() {
                    window.location.href = "/cart/"; // Quay l·∫°i gi·ªè h√†ng
                });

                document.getElementById("goToOrdersBtn").addEventListener("click", function() {
                    window.location.href = "/profile/orders/"; // ƒê·∫øn l·ªãch s·ª≠ ƒë∆°n h√†ng
                });
            } else {
                alert("‚ùå L·ªói: " + (result.error || "C√≥ l·ªói x·∫£y ra!"));
            }
      } catch (error) {
          console.error("L·ªói khi thanh to√°n:", error);
          alert("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!");
      }
  }

  confirmBtn.addEventListener("click", async function (event) {
      event.preventDefault();

      const authToken = await getAuthToken();
      if (!authToken) {
          alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c.");
          window.location.href = "/login/";
          return;
      }

      const selectedMethod = document.querySelector("input[name='phuong_thuc_tt']:checked")?.value;
      const onlineMethod = document.querySelector("input[name='phuong_thuc_online']:checked")?.value || null;
      const selectedItems = Array.from(document.querySelectorAll("tbody tr"), row => ({
          san_pham_id: row.dataset.id,
          so_luong: row.dataset.quantity
      }));

      if (!selectedMethod || selectedItems.length === 0) {
          alert("Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n v√† √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m!");
          return;
      }
      if (selectedMethod === "online" && !onlineMethod) {
          alert("Vui l√≤ng ch·ªçn c·ªïng thanh to√°n!");
          return;
      }

      confirmBtn.disabled = true;
      confirmBtn.innerText = "ƒêang x·ª≠ l√Ω...";

      try {
          // üõí **B∆Ø·ªöC 1: T·∫°o ƒë∆°n h√†ng**
          const orderId = await createOrder(selectedItems, selectedMethod, onlineMethod);
          if (!orderId) {
              confirmBtn.disabled = false;
              confirmBtn.innerText = "‚úÖ Thanh to√°n";
              return;
          }

          // üí≥ **B∆Ø·ªöC 2: Thanh to√°n ƒë∆°n h√†ng v·ª´a t·∫°o**
          await processPayment(orderId, selectedMethod, onlineMethod);
      } finally {
          confirmBtn.disabled = false;
          confirmBtn.innerText = "‚úÖ Thanh to√°n";
      }
  });

});
</script>
{% endblock %}
